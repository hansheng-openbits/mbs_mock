{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/rmbs/dealspec.v1.1.schema.json",
  "title": "Non-Agency RMBS DealSpec v1.1",
  "type": "object",
  "required": [
    "meta", "dates", "collateral", "bonds", "funds", "accounts", 
    "variables", "waterfalls"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "required": ["deal_id", "deal_name"],
      "properties": {
        "deal_id": { "type": "string" },
        "deal_name": { "type": "string" },
        "asset_type": { "type": "string" },
        "version": { "type": "string" }
      }
    },
    "dates": {
      "type": "object",
      "required": ["cutoff_date", "closing_date", "first_payment_date", "payment_frequency", "day_count"],
      "properties": {
        "cutoff_date": { "type": "string", "format": "date" },
        "closing_date": { "type": "string", "format": "date" },
        "first_payment_date": { "type": "string", "format": "date" },
        "payment_frequency": { "type": "string", "enum": ["MONTHLY", "QUARTERLY"] },
        "day_count": { "type": "string", "enum": ["30_360", "ACT_360", "ACT_365", "ACT_ACT"] }
      }
    },
    "collateral": {
      "type": "object",
      "required": ["original_balance"],
      "properties": {
        "original_balance": { "type": "number", "minimum": 0 },
        "loan_data": { "type": "object" },
        "model_interface": { "type": "object" }
      }
    },
    "funds": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "description"],
        "properties": {
          "id": { "type": "string" },
          "description": { "type": "string" }
        }
      }
    },
    "accounts": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "type"],
        "properties": {
          "id": { "type": "string" },
          "type": { "type": "string" },
          "target_rule": { "type": "string" }
        }
      }
    },
    "variables": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    },
    "tests": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "kind", "calc", "threshold"],
        "properties": {
          "id": { "type": "string" },
          "kind": { "type": "string" },
          "calc": { "type": "object" },
          "threshold": { "type": "object" },
          "pass_if": { "type": "string" },
          "effects": { "type": "array" }
        }
      }
    },
    "bonds": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "type", "original_balance", "priority", "coupon"],
        "properties": {
          "id": { "type": "string" },
          "type": { "type": "string", "enum": ["NOTE", "IO", "RESIDUAL"] },
          "original_balance": { "type": "number" },
          "priority": {
            "type": "object",
            "required": ["interest", "principal"],
            "properties": {
              "interest": { "type": "integer" },
              "principal": { "type": "integer" }
            }
          },
          "coupon": {
            "type": "object",
            "required": ["kind"],
            "properties": {
              "kind": { "type": "string", "enum": ["FIXED", "FLOAT", "WAC", "VARIABLE"] },
              "fixed_rate": { "type": "number" },
              "variable_cap": { "type": "string" }
            }
          }
        }
      }
    },
    "waterfalls": {
      "type": "object",
      "required": ["interest", "principal", "loss_allocation"],
      "properties": {
        "interest": { "$ref": "#/$defs/waterfall_steps" },
        "principal": { "$ref": "#/$defs/waterfall_steps" },
        "loss_allocation": {
           "type": "object",
           "required": ["write_down_order"],
           "properties": {
             "loss_source_rule": { "type": "string" },
             "write_down_order": { "type": "array", "items": { "type": "string" } }
           }
        }
      }
    }
  },
  "$defs": {
    "waterfall_steps": {
      "type": "object",
      "required": ["steps"],
      "properties": {
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "action", "from_fund"],
            "properties": {
              "id": { "type": "string" },
              "action": { 
                "type": "string",
                "enum": ["PAY_FEE", "PAY_BOND_INTEREST", "PAY_BOND_PRINCIPAL", "TRANSFER_FUND", "REIMBURSE_ADVANCES"] 
              },
              "from_fund": { "type": "string" },
              "to": { "type": "string" },
              "group": { "type": "string" },
              "amount_rule": { "type": "string" },
              "condition": { "type": "string" },
              "unpaid_ledger_id": { "type": "string" }
            }
          }
        }
      }
    }
  }
}